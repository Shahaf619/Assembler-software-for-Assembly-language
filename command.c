#include "data.h"
#include "input.h"
#include "symbols.h"
#include "guide.h"
#include "command.h"
#include "ram.h"
#include <string.h>
#include <stdio.h>

/*======================================================================================================================================*/
/*--------------------------------------------function to analyze command line statement------------------------------------------------*/
/*======================================================================================================================================*/
int analyze_command ( char line [MAX_LINE_LENGTH], char word [MAX_LINE_LENGTH], const char * commands [MAX_COMMANDS], byte ram[RAM_LENGTH], int * IC, ptr_symbols  symbol_table, char names_extern [MAX_DATA_LENGTH] [MAX_SYMBOL_LENGTH], int names_count_extern, int line_number, char symbol_command [MAX_DATA_LENGTH] )
{ 
     int command;
     int register_source = FALSE, register_destination = FALSE; /* sign if source operand is register name */
     int success = FALSE; /* for sign that source operand is legal */
     int temp_address; /* to store temporary address of symbol operands */
     int status_comma = TRUE; /* sign to if comma is missing */
     int status_register; /* for save register's address */
     int comma_space = START; /* for comma_space function */
     int one_operand = FALSE;
     unsigned ARE, DES = NO_ADDRESSING, OP, SRC = NO_ADDRESSING; /* for initializing ram */
     ARE = ABSOLUTE; /* first byte in command line is absolute */
     /*---------------------------------------------------------------------------*/
     /*-------------------check if word is a command statement--------------------*/
     /*---------------------------------------------------------------------------*/
     if ( ( command = is_command ( word, commands ) ) != END )
     {
          /*---------------------------------------------------------------------------*/
          /*--add space after each comma to separate it to tokens for scan it properly-*/
          /*---------------------------------------------------------------------------*/ 
          while ( ( comma_space = add_spaces ( line, comma_space ) ) != FALSE )
                  ;

          ram [ *IC ].which = INSTRUCTION_BYTE; /* first byte is for instruction byte */
            
          switch ( command )
          {

/*===================================================================================================================================*/
/*-------------------------------------------------------move command----------------------------------------------------------------*/
/*===================================================================================================================================*/
               case MOV: 
                        all_addressing_source_mac ( MOV );
                        addressing_3_5_destination_mac();
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC );  

                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac();                        
                                  
                            } /* 30 */
                        error_mac( mov );
                        break;

/*===================================================================================================================================*/
/*-------------------------------------------------------compare command-------------------------------------------------------------*/
/*===================================================================================================================================*/
               case CMP:
                        all_addressing_source_mac ( CMP ); 
                        all_addressing_destination_mac();
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC ); 
     
                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac();                      
                                  
                            } /* 30 */
                            
                        error_mac( cmp );

                        break;

/*===================================================================================================================================*/
/*----------------------------------------------------------add command--------------------------------------------------------------*/
/*===================================================================================================================================*/
               case ADD:
                        all_addressing_source_mac ( ADD );
                        addressing_3_5_destination_mac(); 
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC ); 

                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac();      printf("IC= %d\n", *IC);                      
                                  
                            } /* 30 */

                        error_mac( add );
                        break;

/*===================================================================================================================================*/
/*------------------------------------------------------subtract command-------------------------------------------------------------*/
/*===================================================================================================================================*/

               case SUB:
                        all_addressing_source_mac ( SUB );
                        addressing_3_5_destination_mac();
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC ); 

                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac();                           
                                  
                            } /* 30 */

                        error_mac( sub );
                        break;

/*===================================================================================================================================*/
/*---------------------------------------------------------not command---------------------------------------------------------------*/
/*===================================================================================================================================*/
               case NOT:
                        one_operand = TRUE;
                        addressing_3_5_destination_one_operand_mac ( NOT, not );
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC ); 

                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac();  
                        break;

/*===================================================================================================================================*/
/*---------------------------------------------------------clr command---------------------------------------------------------------*/
/*===================================================================================================================================*/
               case CLR:
                        one_operand = TRUE;
                        addressing_3_5_destination_one_operand_mac ( CLR, clr );
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC ); 

                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac();  
                        break;

/*===================================================================================================================================*/
/*---------------------------------------------------------lea command---------------------------------------------------------------*/
/*===================================================================================================================================*/
               case LEA:
                        addressing_3_source_mac ( LEA );
                        addressing_3_5_destination_mac();
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC );

                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac();  

                      } /* 30 */
                        error_mac( lea );
                        break;

/*===================================================================================================================================*/
/*---------------------------------------------------------lea command---------------------------------------------------------------*/
/*===================================================================================================================================*/
               case INC:
                        one_operand = TRUE;
                        addressing_3_5_destination_one_operand_mac ( INC, inc );
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC ); 

                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac(); 
                        break;

/*===================================================================================================================================*/
/*---------------------------------------------------------dec command---------------------------------------------------------------*/
/*===================================================================================================================================*/
               case DEC:
                        one_operand = TRUE;
                        addressing_3_5_destination_one_operand_mac ( DEC, dec );
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC ); 

                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac();
                        break;

/*===================================================================================================================================*/
/*---------------------------------------------------------jmp command---------------------------------------------------------------*/
/*===================================================================================================================================*/
               case JMP:
                        one_operand = TRUE;
                        addressing_3_5_destination_one_operand_mac ( JMP, jmp ); 
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC ); 

                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac(); 
                        break;

/*===================================================================================================================================*/
/*---------------------------------------------------------bne command---------------------------------------------------------------*/
/*===================================================================================================================================*/
               case BNE:
                        one_operand = TRUE;
                        addressing_3_5_destination_one_operand_mac ( BNE, bne );
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC ); 

                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac();
                        break;

/*===================================================================================================================================*/
/*---------------------------------------------------------red command---------------------------------------------------------------*/
/*===================================================================================================================================*/
               case RED:
                        one_operand = TRUE;
                        addressing_3_5_destination_one_operand_mac ( RED, red );
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC ); 

                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac();
                        break;

/*===================================================================================================================================*/
/*---------------------------------------------------------prn command---------------------------------------------------------------*/
/*===================================================================================================================================*/
               case PRN:
                        one_operand = TRUE;
                        addressing_1_3_5_destination_one_operand_mac ( PRN, prn );
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC ); 

                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac();
                        break;

/*===================================================================================================================================*/
/*---------------------------------------------------------jsr command---------------------------------------------------------------*/
/*===================================================================================================================================*/
               case JSR:
                        one_operand = TRUE;
                        addressing_3_5_destination_one_operand_mac ( JSR, jsr );
                        add_instruction ( ram, *IC, ARE, DES, OP, SRC ); 

                        /*---------------------------------------------------------------------------*/
                        /*--------increment IC depanding on how many bytes is already encoded--------*/
                        /*---------------------------------------------------------------------------*/
                        increment_IC_mac();
                        break;

/*===================================================================================================================================*/
/*---------------------------------------------------------rts command---------------------------------------------------------------*/
/*===================================================================================================================================*/
               case RTS:
                        addressing_no_operands ( RTS, rts ); 
                        break;

/*===================================================================================================================================*/
/*--------------------------------------------------------stop command---------------------------------------------------------------*/
/*===================================================================================================================================*/
               case STOP:
                         addressing_no_operands ( STOP, stop ); 
                        break;
          }
     }
 
     else /* word isn't a command statement, error */
     {
          printf( "error at line %d: undefined coomand line statement\n", line_number );
          return FALSE;
     }
}

/*======================================================================================================================================*/
/*----------------------------------------function to check if word is a command statement----------------------------------------------*/
/*======================================================================================================================================*/
int is_command ( char word [MAX_LINE_LENGTH], const char * commands [MAX_COMMANDS] )
{
     is_command_mac ( commands [MOV], MOV );
     is_command_mac ( commands [CMP], CMP );
     is_command_mac ( commands [ADD], ADD );
     is_command_mac ( commands [SUB], SUB );
     is_command_mac ( commands [NOT], NOT );
     is_command_mac ( commands [CLR], CLR );
     is_command_mac ( commands [LEA], LEA );
     is_command_mac ( commands [INC], INC );
     is_command_mac ( commands [DEC], DEC );
     is_command_mac ( commands [JMP], JMP );
     is_command_mac ( commands [BNE], BNE );
     is_command_mac ( commands [RED], RED );
     is_command_mac ( commands [PRN], PRN );
     is_command_mac ( commands [JSR], JSR );
     is_command_mac ( commands [RTS], RTS );
     is_command_mac ( commands [STOP], STOP );
    
    return END;
}

/*======================================================================================================================================*/
/*-------------------------------------------function to check if word is a symbol name-------------------------------------------------*/
/*======================================================================================================================================*/
int is_symbol_name ( ptr_symbols sym, char word [MAX_LINE_LENGTH] )
{ 
    for ( ; sym; sym = sym-> next ) 
    {
        if ( strcmp ( word, sym-> name ) == 0 )
             return sym-> address;
    }
    return END; 
}

int is_symbol_name_command ( ptr_symbols sym, char word [MAX_LINE_LENGTH] )
{ 
    for ( ; sym; sym = sym-> next ) 
    { 
        if ( strcmp ( word, sym-> name ) == 0 )
        { 
             if ( sym-> guide == FALSE ) 
                 return TRUE; 
                  
             else
                  return FALSE;
        }
             
    }
    return END; 
}

/*======================================================================================================================================*/
/*----------------------------------------function to check if word is extern symbol name-----------------------------------------------*/
/*======================================================================================================================================*/
int is_symbol_name_extern ( char names_extern [MAX_DATA_LENGTH] [MAX_SYMBOL_LENGTH], int names_count_extern, char word [MAX_LINE_LENGTH] )
{
    int i;
    for ( i = 0; i < names_count_extern; i++ )
    {
        if ( strcmp ( word, names_extern [i] ) == 0 )
             return TRUE;
    }
    return FALSE;
}

/*======================================================================================================================================*/
/*-------------------------------------------function to check if symbol name is extern-------------------------------------------------*/
/*======================================================================================================================================*/
int is_symbol_external ( ptr_symbols sym, char word [MAX_LINE_LENGTH] )
{
    for ( ; sym; sym = sym-> next )
    {
        if ( strcmp ( word, sym-> name ) == 0 )
            if ( sym-> external == TRUE )
                 return TRUE;
            else
                 return FALSE;
    }
    return END;
}

/*======================================================================================================================================*/
/*-------------------------------------------function to check if word is a register name-----------------------------------------------*/
/*======================================================================================================================================*/
int is_register_name ( char word [MAX_LINE_LENGTH] )
{
        is_register_name_mac ( REGISTER_0, REG_0 );
        is_register_name_mac ( REGISTER_1, REG_1 );
        is_register_name_mac ( REGISTER_2, REG_2 );
        is_register_name_mac ( REGISTER_3, REG_3 );
        is_register_name_mac ( REGISTER_4, REG_4 );
        is_register_name_mac ( REGISTER_5, REG_5 );
        is_register_name_mac ( REGISTER_6, REG_6 );
        is_register_name_mac ( REGISTER_7, REG_7 );
        return FALSE;
}



